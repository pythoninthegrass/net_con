version: "3.0"

tasks:
  create:
    desc: Create a kind cluster for local development using ctlptl
    cmds:
      - |
        ctlptl apply -f - <<EOF
        apiVersion: ctlptl.dev/v1alpha1
        kind: Registry
        name: ctlptl-registry
        port: 5005
        ---
        apiVersion: ctlptl.dev/v1alpha1
        kind: Cluster
        product: kind
        name: kind-kind
        registry: ctlptl-registry
        kindV1Alpha4Cluster:
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
        EOF
    status:
      - ctlptl get cluster kind-kind

  delete:
    desc: Delete the kind cluster and registry using ctlptl
    cmds:
      - ctlptl delete cluster kind-kind --ignore-not-found
      - ctlptl delete registry ctlptl-registry --ignore-not-found

  load:
    desc: Load the Docker image into kind cluster
    deps:
      - :docker:buildx
    cmds:
      - kind load docker-image {{.FULL_IMAGE}} --name kind

  registry-url:
    desc: Get the local registry URL for the kind cluster
    cmds:
      - ctlptl get cluster kind-kind -o template --template '{{.status.localRegistryHosting.host}}'
